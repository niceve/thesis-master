<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.242">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>system-architecture</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


</head>

<body>

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#system-architecture" id="toc-system-architecture" class="nav-link active" data-scroll-target="#system-architecture"><span class="header-section-number">1</span> System architecture</a>
  <ul class="collapse">
  <li><a href="#high-level-components" id="toc-high-level-components" class="nav-link" data-scroll-target="#high-level-components"><span class="header-section-number">1.1</span> High-level components</a>
  <ul class="collapse">
  <li><a href="#hardware" id="toc-hardware" class="nav-link" data-scroll-target="#hardware"><span class="header-section-number">1.1.1</span> Hardware</a></li>
  <li><a href="#software-defined-radio" id="toc-software-defined-radio" class="nav-link" data-scroll-target="#software-defined-radio"><span class="header-section-number">1.1.2</span> Software-defined radio</a></li>
  <li><a href="#operating-system" id="toc-operating-system" class="nav-link" data-scroll-target="#operating-system"><span class="header-section-number">1.1.3</span> Operating system</a></li>
  <li><a href="#signal-processing-and-analysis" id="toc-signal-processing-and-analysis" class="nav-link" data-scroll-target="#signal-processing-and-analysis"><span class="header-section-number">1.1.4</span> Signal processing and analysis</a></li>
  <li><a href="#user-interface-and-management" id="toc-user-interface-and-management" class="nav-link" data-scroll-target="#user-interface-and-management"><span class="header-section-number">1.1.5</span> User interface and management</a></li>
  </ul></li>
  <li><a href="#backend-architecture" id="toc-backend-architecture" class="nav-link" data-scroll-target="#backend-architecture"><span class="header-section-number">1.2</span> Backend architecture</a>
  <ul class="collapse">
  <li><a href="#sec-restApi" id="toc-sec-restApi" class="nav-link" data-scroll-target="#sec-restApi"><span class="header-section-number">1.2.1</span> REST API</a></li>
  <li><a href="#sec-signalStorage" id="toc-sec-signalStorage" class="nav-link" data-scroll-target="#sec-signalStorage"><span class="header-section-number">1.2.2</span> Signal measurements storage</a></li>
  <li><a href="#database-access-layer" id="toc-database-access-layer" class="nav-link" data-scroll-target="#database-access-layer"><span class="header-section-number">1.2.3</span> Database access layer</a></li>
  </ul></li>
  <li><a href="#node-architecture" id="toc-node-architecture" class="nav-link" data-scroll-target="#node-architecture"><span class="header-section-number">1.3</span> Node architecture</a>
  <ul class="collapse">
  <li><a href="#system-metrics-collector" id="toc-system-metrics-collector" class="nav-link" data-scroll-target="#system-metrics-collector"><span class="header-section-number">1.3.1</span> System metrics collector</a></li>
  <li><a href="#process-manager" id="toc-process-manager" class="nav-link" data-scroll-target="#process-manager"><span class="header-section-number">1.3.2</span> Process manager</a></li>
  <li><a href="#user-interface" id="toc-user-interface" class="nav-link" data-scroll-target="#user-interface"><span class="header-section-number">1.3.3</span> User interface</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">



<section id="system-architecture" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> System architecture</h1>
<p>Several different software components are required to ensure the system can:</p>
<ul>
<li>persist general data on disk, such as node telemetry and hardware information</li>
<li>receive and store large volumes of radio signal samples organized in </li>
<li>maintain a reliable and fault-tolerant connection between the backend and an unknown number of nodes</li>
</ul>
<p>The currently implemented software architecture is summarized in <a href="#fig-systemArch">Figure&nbsp;1.1</a>.</p>
<div>
<div id="fig-systemArch" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="system-architecture_files/mediabag/87564f458bd2f99a401c26a0dbdd337153acd24f.svg" style="height:40.0%" class="figure-img"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;1.1: high-level system architecture</figcaption><p></p>
</figure>
</div>
</div>
<section id="high-level-components" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="high-level-components"><span class="header-section-number">1.1</span> High-level components</h2>
<p>OpenRFSense is built upon several different modern technologies, interconnected by mainstream networking protocols.</p>
<section id="hardware" class="level3" data-number="1.1.1">
<h3 data-number="1.1.1" class="anchored" data-anchor-id="hardware"><span class="header-section-number">1.1.1</span> Hardware</h3>
<p>OpenRFSense is designed to run on a variety of hardware platforms, including PCs, servers, and embedded systems. The hardware requirements depend on the specific use case and workload, but typically include a multi-core processor, sufficient memory and storage, and one or more software-defined radio (SDR) devices acting as signal receivers.</p>
</section>
<section id="software-defined-radio" class="level3" data-number="1.1.2">
<h3 data-number="1.1.2" class="anchored" data-anchor-id="software-defined-radio"><span class="header-section-number">1.1.2</span> Software-defined radio</h3>
<p>OpenRFSense relies on one or more SDR devices to capture and analyze radio frequency signals. The SDR devices are connected to the hardware platform via USB or PCIe interfaces and can be controlled using open-source software libraries such as GNU Radio. The SDR device is responsible for capturing radio signals from the environment.</p>
</section>
<section id="operating-system" class="level3" data-number="1.1.3">
<h3 data-number="1.1.3" class="anchored" data-anchor-id="operating-system"><span class="header-section-number">1.1.3</span> Operating system</h3>
<p>Thanks to the choice of programming language (Golang <span class="citation" data-cites="GoProgrammingLanguage">(<a href="#ref-GoProgrammingLanguage" role="doc-biblioref"><span>“The <span>Go Programming Language</span>,”</span> n.d.</a>)</span>), both the backend and node software can be compiled and deployed on most modern operating systems and hardware configurations (e.g.&nbsp;Windows on ARM, Linux on x86, MacOS on M1). The backend service is also developed with containerization in mind, making it possible to deploy the software securely and avoiding strict dependency on host system configuration.</p>
</section>
<section id="signal-processing-and-analysis" class="level3" data-number="1.1.4">
<h3 data-number="1.1.4" class="anchored" data-anchor-id="signal-processing-and-analysis"><span class="header-section-number">1.1.4</span> Signal processing and analysis</h3>
<p>OpenRFSense uses a variety of signal processing and analysis techniques to extract useful information from the captured radio frequency signals. This includes techniques such as Fast Fourier Transform <span class="citation" data-cites="heidemanGaussHistoryFast1984">(<a href="#ref-heidemanGaussHistoryFast1984" role="doc-biblioref">Heideman, Johnson, and Burrus 1984</a>)</span> (FFT), digital signal processing (DSP), and machine learning algorithms. See <strong>?@sec-signalProcessing</strong> for a more in-depth explanation of the data analysis process.</p>
</section>
<section id="user-interface-and-management" class="level3" data-number="1.1.5">
<h3 data-number="1.1.5" class="anchored" data-anchor-id="user-interface-and-management"><span class="header-section-number">1.1.5</span> User interface and management</h3>
<p>OpenRFSense provides a web-based user interface for configuring, managing, and visualizing the captured data. The user interface includes features such as real-time spectrum displays, signal analysis tools, and alerting mechanisms. The system also provides APIs for integration with external tools and services.</p>
</section>
</section>
<section id="backend-architecture" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="backend-architecture"><span class="header-section-number">1.2</span> Backend architecture</h2>
<p>The backend service is a monolithic application which combines user interface and data management code. It can be broken down into several modular components which all depend only on shared configuration in the form of a file or environment variables on the host system.</p>
<p>The internal messaging service maintains a constant communication stream between the backend and the various nodes deployed by the user. It provides a scalable and fault-tolerant solution for message delivery to the remote nodes. It is documented in <strong>?@sec-serviceMessaging</strong>.</p>
<p>Another critical component is the web-based user interface (UI) which is the main interactive mean for the user to communicate with the other components inside the backend service. An in-depth explanation, complete with other high-level considerations, is contained in <strong>?@sec-ui</strong>.</p>
<section id="sec-restApi" class="level3" data-number="1.2.1">
<h3 data-number="1.2.1" class="anchored" data-anchor-id="sec-restApi"><span class="header-section-number">1.2.1</span> REST API</h3>
<p>To allow external access to stored data, a REST (REpresentational State Transfer, defined in <span class="citation" data-cites="fieldingArch2000">(<a href="#ref-fieldingArch2000" role="doc-biblioref">R. T. Fielding and Taylor 2000</a>)</span>) API is provided by the backend. Such a system allows authorized applications to query data through a standardized interface. Currently, the following data can be fetched from the backend:</p>
<ul>
<li>signal measurements taken by a specific node and belonging to a certain campaign</li>
<li>a list of all nodes currently connected to the messaging system</li>
<li>node metrics and system status for a specific node</li>
</ul>
<p>The API can also actively request actions to be carried out by the nodes. To ensure bad actors cannot arbitrarily send command requests to the system, all requests which perform an action that can change the state of the system require a form of authentication. The currently implemented authentication method is Basic HTTP Authentication (a Web standard, see <span class="citation" data-cites="RFC7235">(<a href="#ref-RFC7235" role="doc-biblioref">R. Fielding and Reschke 2014</a>)</span>).</p>
</section>
<section id="sec-signalStorage" class="level3" data-number="1.2.2">
<h3 data-number="1.2.2" class="anchored" data-anchor-id="sec-signalStorage"><span class="header-section-number">1.2.2</span> Signal measurements storage</h3>
<p>Since radio signal data can be dense and structured as large inbound TCP packets, a storage layer capable of extremely fast writes to memory is needed. The BadgerDB <span class="citation" data-cites="BadgerDB">(<a href="#ref-BadgerDB" role="doc-biblioref"><span>“<span>BadgerDB</span>,”</span> n.d.</a>)</span> key-value store was chosen due to the maturity of the software and it being natively developed in Golang, providing easier integration into the existing backend code. BadgerDB is capable, in optimal conditions (sufficient RAM and a modern solid state disk), of writing several gigabytes of data per second to disk. In practical testing, BadgerDB has proven more than sufficient for handling raw inbound signal data from several nodes at a time.</p>
</section>
<section id="database-access-layer" class="level3" data-number="1.2.3">
<h3 data-number="1.2.3" class="anchored" data-anchor-id="database-access-layer"><span class="header-section-number">1.2.3</span> Database access layer</h3>
<p>A support database is used to store persistent data, which is required to survive service outages or is generally better kept for an unspecified amount of time. PostgreSQL <span class="citation" data-cites="groupPostgreSQL2023">(<a href="#ref-groupPostgreSQL2023" role="doc-biblioref">Group 2023</a>)</span> was chosen mainly due to the maturity and notoriety of the project. From the project website:</p>
<blockquote class="blockquote">
<p><em>PostgreSQL is a powerful, open source object-relational database system that uses and extends the SQL language combined with many features that safely store and scale the most complicated data workloads.</em></p>
</blockquote>
<p>PostgreSQL is widely available and easily deployable even using container technology. A native Golang implementation of the database connection and communication protocol is used internally to store data such as past node metrics received through the messaging system, or signal measurement campaign data (start date and time, end date and time, etc.). Such data is then available for querying through the REST API documented above (in <a href="#sec-restApi">Section&nbsp;1.2.1</a>).</p>
</section>
</section>
<section id="node-architecture" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="node-architecture"><span class="header-section-number">1.3</span> Node architecture</h2>
<p>The node software is developed upon much the same technologies as the backend to ease integration between the two and reduce development overhead. Being developed to run natively on embedded devices as a self-contained application, several software components are needed to fullfil all required functions.</p>
<p>The application is available both as a standalone, statically-linked executable and a more user-friendly prebuilt system image based on the Raspbian OS. The system image comes pre-configured with required system components such as:</p>
<ul>
<li>a SystemD <span class="citation" data-cites="Systemd">(<a href="#ref-Systemd" role="doc-biblioref"><span>“Systemd,”</span> n.d.</a>)</span> service which starts the node management software on boot</li>
<li>the OpenRFSense node management application</li>
<li>the external, low-level program which interfaces with the SDR hardware (<code>orfs-sensor</code>)</li>
<li>some useful signal decoding software, also part of the project</li>
</ul>
<p>The following sections describe the main components of the node management software.</p>
<section id="system-metrics-collector" class="level3" data-number="1.3.1">
<h3 data-number="1.3.1" class="anchored" data-anchor-id="system-metrics-collector"><span class="header-section-number">1.3.1</span> System metrics collector</h3>
<p>A critical component for the node software is the metrics collector. This component is responsible for providing a current snapshot of the status of both hardware and software of the system, which will then be stored by the backend. The metrics message format and message exchange is documented more extensively in <strong>?@sec-metrics</strong>.</p>
</section>
<section id="process-manager" class="level3" data-number="1.3.2">
<h3 data-number="1.3.2" class="anchored" data-anchor-id="process-manager"><span class="header-section-number">1.3.2</span> Process manager</h3>
<p>The node software relies on an external process for data acquisition and delivery. Not being originally developed with integration in mind, such a program is managed as a zero-knowledge black box, executed as a child process by generating command-line arguments and passing them to the program.</p>
<div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="system-architecture_files/mediabag/a840b9f1c0f4a3b3cc6432e7dbfa0168005e76ec.svg" class="img-fluid figure-img" style="width:70.0%"></p>
<p></p><figcaption class="figure-caption">measurement process flow</figcaption><p></p>
</figure>
</div>
</div>
</section>
<section id="user-interface" class="level3" data-number="1.3.3">
<h3 data-number="1.3.3" class="anchored" data-anchor-id="user-interface"><span class="header-section-number">1.3.3</span> User interface</h3>
<p>Much like the backend, the node provides users with a web-based UI to manage system functionality. Additionally, the UI lets users configure and reboot the system without needing an external monitor or peripherals for easier system administration of embedded devices. A description of the node UI with screenshots is contained in <strong>?@sec-nodeUi</strong>.</p>
<p>The interface is only accessible on the same network as the node, to avoid exposing administration functionality to the public internet. Additionally, for thirty minutes after the system is booted, the UI is accessible by connecting to the device through a temporary WiFi access point if the hardware is capable of creating one such connection.</p>


<div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-BadgerDB" class="csl-entry" role="listitem">
<span>“<span>BadgerDB</span>.”</span> n.d. <a href="https://dgraph.io/docs/badger">https://dgraph.io/docs/badger</a>.
</div>
<div id="ref-fieldingArch2000" class="csl-entry" role="listitem">
Fielding, Roy Thomas, and Richard N. Taylor. 2000. <span>“Architectural Styles and the Design of Network-Based Software Architectures.”</span> <span>University of California, Irvine</span>.
</div>
<div id="ref-RFC7235" class="csl-entry" role="listitem">
Fielding, R., and J. Reschke. 2014. <span>“Hypertext Transfer Protocol (<span>HTTP</span>/1.1): <span>Authentication</span>.”</span> RFC 7235. <span>RFC Editor / RFC Editor</span>; Internet Requests for Comments. <a href="http://www.rfc-editor.org/rfc/rfc7235.txt">http://www.rfc-editor.org/rfc/rfc7235.txt</a>.
</div>
<div id="ref-groupPostgreSQL2023" class="csl-entry" role="listitem">
Group, PostgreSQL Global Development. 2023. <span>“<span>PostgreSQL</span>.”</span> <span>PostgreSQL</span>. February 25, 2023. <a href="https://www.postgresql.org/">https://www.postgresql.org/</a>.
</div>
<div id="ref-heidemanGaussHistoryFast1984" class="csl-entry" role="listitem">
Heideman, M., D. Johnson, and C. Burrus. 1984. <span>“Gauss and the History of the Fast Fourier Transform.”</span> <em>IEEE ASSP Magazine</em> 1 (4): 14–21. <a href="https://doi.org/10.1109/MASSP.1984.1162257">https://doi.org/10.1109/MASSP.1984.1162257</a>.
</div>
<div id="ref-Systemd" class="csl-entry" role="listitem">
<span>“Systemd.”</span> n.d. <a href="https://www.freedesktop.org/wiki/Software/systemd/">https://www.freedesktop.org/wiki/Software/systemd/</a>.
</div>
<div id="ref-GoProgrammingLanguage" class="csl-entry" role="listitem">
<span>“The <span>Go Programming Language</span>.”</span> n.d. <a href="https://go.dev/">https://go.dev/</a>.
</div>
</div>
</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>