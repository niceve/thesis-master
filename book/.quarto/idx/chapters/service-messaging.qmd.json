{"title":"Service messaging","markdown":{"headingText":"Service messaging","headingAttr":{"id":"sec-serviceMessaging","classes":[],"keyvalue":[]},"containsRefs":false,"markdown":"In OpenRFSense, NATS messaging [@NATS] is used to enable communication between the backend and the nodes. NATS (Neural Autonomic Transport System) is a lightweight messaging system that is commonly used for machine-to-machine (M2M) communication in IoT (Internet of Things) applications. A messaging system such as NATS is based on message delivery guarantees and optional message retention for later delivery. These capabilities ensure service message resiliency through high-latency connections and in-flight data loss.\n\nThe backend acts as the NATS server and the nodes act as NATS clients which connect to the server. When a node is powered on, it connects to the NATS server and subscribes to a \\enquote{subject}, which is a named destination to which messages are published. The node can subscribe to one or more subjects depending on its capabilities. Some subjects currently being used for service messages are:\n\n* `node.all` for node system metrics (see @sec-metrics)\n* `node.all.aggregated` and `node.all.raw` for backend-to-node signal recording commands (see @sec-commands)\n* `node.$hardware_id.$command`, where `$hardware_id` is the node's unique identifier and `$command` is a specific action being requested\n\n## Node metrics {#sec-metrics}\nThe backend, when requested through the REST API or the web UI, sends a \\enquote{status request} message to a specific NATS subject (to which all nodes are required to listen on). All nodes then start collecting internal metrics (such as CPU usage and temperature, memory usage etc.) and respond on the same subject with the collected data, encoded in JSON (JavaScript Object Notation) format [@ecmaECMA404JSONData2017].\n\n```{#fig-metrics .d2 fig-cap=\"node metrics request flow\"}\ndirection: right\n\nbackend: {\n  REST API\n  UI\n  NATS server\n\n  REST API -> NATS server\n  UI -> NATS server\n}\n\nsubject: |sh\n  node.all\n|\n\nbackend.NATS server -> subject\nsubject -> node1\nsubject -> node2\nnode1 -> subject: metrics\nnode2 -> subject: metrics\n```\n\n### Metrics contents\nA metrics object contains useful system data such as:\n\n* the system hostname\n* a unique hardware ID derived from the motherboard model\n* the motherboard/hardware model of the system\n* the system's online time (uptime) in milliseconds since it was powered on\n\nAdditionally, a variable-content section is reserved for less crucial information. This section is never required nor checked by the backend, but its data, if present, is shown to the user through the web UI. Currently, such data is provided by small standardized software modules (\\enquote{providers}), which are called by the node management software if present. Some currently implemented providers are:\n\n* node geographical location in GeoJSON [@RFC7946] format\n* filesystem usage\n* memory (RAM) usage\n* network connections\n* current node availability (free, busy, handling errors, etc.)\n\n### Message encoding\nAs stated above, node metrics are encoded in JSON format to be easily accessible by external services, since JSON is a well-established industry standard data format. An example of the metrics data encoded in textual JSON is [@lst-metrics].\n\n```{#lst-metrics .json lst-cap=\"example metrics object in JSON format\"}\n{\n  \"id\": \"kgslnximugwhsfnwbjknwbv\",\n  \"hostname\": \"raspberry\",\n  \"model\": \"Raspberry Pi 3B\",\n  \"uptime\": 186339250000000,\n  \"providers\": []\n}\n```\n\n## Commands {#sec-commands}\nThe backend can also publish messages to node-specific subjects. This enables the backend to remotely control the nodes and send configuration updates or commands. The messages can be one of two types:\n\n1. empty messages sent on a specific NATS subject (\\enquote{pings})\n2. JSON-encoded messages containing relevant context for the requested action\n\nWhen a node receives a remote command message, it processes the command and sends a response message back to the backend. The response message can contain any relevant information about the status of the command, such as success or failure, and any associated data. Generally, nodes send their system metrics as response but it is not a strict requirement.\n\n```{#fig-commands .d2 fig-cap=\"sensor campaign command flow\"}\ndirection: right\n\nbackend: {\n  REST API\n  UI\n  NATS server\n\n  REST API -> NATS server\n  UI -> NATS server\n}\n\nsubject: |sh\n  node.all.aggregated\n  node.all.raw\n  node.$hardware_id.$command\n|\n\nbackend.NATS server -> subject\nsubject -> node1\nsubject -> node2\nnode1 -> subject: metrics\nnode2 -> subject: metrics\n```\n","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":false,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"markdown"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","number-sections":true,"toc":true,"filters":["custom-appendices","d2"],"output-file":"service-messaging.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Danger","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search":"Search","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.3.242","bibliography":["../assets/references.bib"],"crossref":{"chapters":true},"d2":{"path":"../../bin/d2/bin/d2","layout":"elk","theme":1}},"extensions":{"book":{"multiFile":true}}}}}